FROM node:18-alpine

WORKDIR /app

# Copy package files
COPY package*.json ./
COPY tsconfig.json ./

# Copy source code
COPY server ./server
COPY client ./client
COPY shared ./shared
COPY drizzle.config.ts ./
COPY vite.config.ts ./
COPY tailwind.config.ts ./
COPY index.html ./
COPY postcss.config.js ./
COPY theme.json ./
COPY public ./public

# Install dependencies
RUN npm ci

# Ensure the application listens on PORT env var
ENV HOST=0.0.0.0

# Build the application
RUN npm run build

# Modify the index.js file to ensure it listens on port 8080 or PORT env var
RUN sed -i 's/const PORT = process.env.PORT || 3000/const PORT = process.env.PORT || 8080/g' dist/server/index.js || true
RUN sed -i 's/const PORT = 5000/const PORT = process.env.PORT || 8080/g' dist/server/index.js || true
RUN sed -i 's/const port = process.env.PORT || 3000/const port = process.env.PORT || 8080/g' dist/server/index.js || true
RUN sed -i 's/const port = 5000/const port = process.env.PORT || 8080/g' dist/server/index.js || true

# Explicitly use port 8080
EXPOSE 8080

# Start the application
CMD ["node", "dist/server/index.js"]